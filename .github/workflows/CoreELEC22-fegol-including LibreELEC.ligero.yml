name: GitHub Automatic Build

on:
  workflow_dispatch:

jobs:
  build:
    name: ${{ matrix.os }}-${{ matrix.device }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          - os: CoreELEC
            tags: origin/coreelec-22
            arch: aarch64
            project: Amlogic-ce
            device: Amlogic-no

          - os: LibreELEC.tv
            tags: origin/master
            arch: aarch64
            project: ARM
            device: ARMv8

          - os: LibreELEC.tv
            tags: origin/master
            arch: x86_64
            project: Generic
            device: Generic

    steps:
      # 1ï¸âƒ£ Checkout repo del workflow
      - name: ğŸ”Œ Checkout
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Liberar espacio (CRÃTICO)
      - name: ğŸ§¹ Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/lib/android "$AGENT_TOOLSDIRECTORY"
          df -h

      # 3ï¸âƒ£ Dependencias
      - name: ğŸ”¨ Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            gcc g++ make git wget zip unzip xz-utils bc curl gperf \
            xsltproc xfonts-utils patchutils lzop libxml-parser-perl \
            libparse-yapp-perl openjdk-11-jre-headless openjdk-17-jre-headless \
            rsync rename jq rdfind

      # 4ï¸âƒ£ Normalizar nombre OS
      - name: âœ‚ï¸ Set OS without extension
        run: echo "os=$(echo ${{ matrix.os }} | cut -d '.' -f 1)" >> $GITHUB_ENV

      # 5ï¸âƒ£ Clonar repo (shallow)
      - name: ğŸ“¥ Download ${{ matrix.os }}
        run: |
          git clone --depth 1 https://github.com/${{ env.os }}/${{ matrix.os }}
          cd ${{ matrix.os }}
          git checkout ${{ matrix.tags }}

      # 6ï¸âƒ£ Parche dvbcsa
      - name: ğŸ˜œ Update dvbcsa
        run: |
          patch -d ${{ matrix.os }} -p1 < .github/patches/up-libdvbcsa.patch

      # 7ï¸âƒ£ Rutas build
      - name: ğŸ” Get path
        run: |
          cd ${{ matrix.os }}
          ARCH=${{ matrix.arch }} PROJECT=${{ matrix.project }} DEVICE=${{ matrix.device }} . config/options
          echo "sources_dir=$SOURCES" >> $GITHUB_ENV
          echo "build_dir=$BUILD" >> $GITHUB_ENV
          echo "project=${DISTRONAME}-${OS_VERSION}" >> $GITHUB_ENV

      # 8ï¸âƒ£ Cache SOLO ccache (NO sources)
      - name: ğŸ’½ Cache ccache
        uses: actions/cache@v4
        with:
          path: ${{ env.build_dir }}/.ccache
          key: ${{ env.project }}-${{ matrix.device }}-ccache

      # 9ï¸âƒ£ Fuentes locales (sin symlink)
      - name: ğŸ“¦ Add fallback sources
        run: |
          mkdir -p ${{ env.sources_dir }}
          rsync -a --ignore-existing .github/sources/ ${{ env.sources_dir }}/

      # ğŸ”Ÿ Parche Tvheadend
      - name: ğŸ˜® Apply Tvheadend patch
        run: |
          cp .github/patches/tvheadend43-newer.patch \
             ${{ matrix.os }}/packages/addons/service/tvheadend43/patches/tvheadend43-100-LS.patch

      # 1ï¸âƒ£1ï¸âƒ£ Compilar addon
      - name: ğŸ‘· Build addon
        run: |
          cd ${{ matrix.os }}
          ARCH=${{ matrix.arch }} PROJECT=${{ matrix.project }} DEVICE=${{ matrix.device }} \
          scripts/create_addon tvheadend43

      # 1ï¸âƒ£2ï¸âƒ£ Subir target completo
      - name: ğŸ“¤ Upload target
        uses: actions/upload-artifact@v4
        with:
          name: target-${{ matrix.os }}-${{ matrix.device }}
          path: ${{ github.workspace }}/${{ matrix.os }}/target/
          compression-level: 9
