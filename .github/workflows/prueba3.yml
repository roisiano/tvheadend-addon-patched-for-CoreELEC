name: GitHub Automatic Build
on:
  workflow_dispatch:

jobs:
  toolchain:
    name: Toolchain-${{ matrix.os }}-${{ matrix.device }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
        - os: CoreELEC
          tags: origin/coreelec-22
          arch: aarch64
          project: Amlogic-ce
          device: Amlogic-no

    steps:
      - name: ğŸ”Œï¸ Checkout
        uses: actions/checkout@v4

      - name: ğŸ”¨ï¸ Install base dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y \
            build-essential git wget zip unzip xz-utils bc curl gperf xsltproc \
            patchutils lzop libxml-parser-perl libparse-yapp-perl \
            openjdk-11-jre-headless openjdk-17-jre-headless \
            rsync rename jq rdfind yasm nasm pkg-config \
            libtool autoconf automake xfonts-utils

      - name: âœ‚ï¸ Set OS without extension
        run: echo "os=$(echo ${{ matrix.os }} | cut -d '.' -f 1)" >> $GITHUB_ENV

      - name: ğŸ“¥ï¸ Download the ${{ matrix.os }}
        run: git clone https://github.com/${{ env.os }}/${{ matrix.os }}

      - name: ğŸ“Œï¸ ${{ matrix.os }} release tags checkout
        run: |
          cd ${{ matrix.os }}
          git checkout ${{ matrix.tags }}

      - name: ğŸ”ï¸ Get path
        run: |
          cd ${{ github.workspace }}/${{ matrix.os }}
          ARCH=${{ matrix.arch }} PROJECT=${{ matrix.project }} DEVICE=${{ matrix.device }} . config/options
          echo "sources_dir=$(echo ${SOURCES})" >> $GITHUB_ENV
          echo "build_dir=$(echo ${BUILD})" >> $GITHUB_ENV
          echo "project=$(echo ${DISTRONAME}-${OS_VERSION})" >> $GITHUB_ENV

      - name: ğŸ‘·ï¸ Build toolchain
        run: |
          cd ${{ github.workspace }}/${{ matrix.os }}
          ARCH=${{ matrix.arch }} PROJECT=${{ matrix.project }} DEVICE=${{ matrix.device }} scripts/build toolchain -j2

      - name: ğŸ“¤ï¸ Upload toolchain artifact
        uses: actions/upload-artifact@v4
        with:
          name: toolchain-${{ env.os }}-${{ matrix.device }}
          path: ${{ env.build_dir }}/toolchain/
          compression-level: 9

  tvheadend:
    name: Tvheadend-${{ matrix.os }}-${{ matrix.device }}
    runs-on: ubuntu-latest
    needs: toolchain
    strategy:
      matrix:
        include:
        - os: CoreELEC
          tags: origin/coreelec-22
          arch: aarch64
          project: Amlogic-ce
          device: Amlogic-no

    steps:
      - name: ğŸ”Œï¸ Checkout
        uses: actions/checkout@v4

      - name: ğŸ”¨ï¸ Install base dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y \
            build-essential git wget zip unzip xz-utils bc curl gperf xsltproc \
            patchutils lzop libxml-parser-perl libparse-yapp-perl \
            openjdk-11-jre-headless openjdk-17-jre-headless \
            rsync rename jq rdfind yasm nasm pkg-config \
            libtool autoconf automake xfonts-utils

      - name: âœ‚ï¸ Set OS without extension
        run: echo "os=$(echo ${{ matrix.os }} | cut -d '.' -f 1)" >> $GITHUB_ENV

      - name: ğŸ“¥ï¸ Download the ${{ matrix.os }}
        run: git clone https://github.com/${{ env.os }}/${{ matrix.os }}

      - name: ğŸ“Œï¸ ${{ matrix.os }} release tags checkout
        run: |
          cd ${{ matrix.os }}
          git checkout ${{ matrix.tags }}

      - name: ğŸ”ï¸ Get path
        run: |
          cd ${{ github.workspace }}/${{ matrix.os }}
          ARCH=${{ matrix.arch }} PROJECT=${{ matrix.project }} DEVICE=${{ matrix.device }} . config/options
          echo "sources_dir=$(echo ${SOURCES})" >> $GITHUB_ENV
          echo "build_dir=$(echo ${BUILD})" >> $GITHUB_ENV
          echo "project=$(echo ${DISTRONAME}-${OS_VERSION})" >> $GITHUB_ENV

      - name: ğŸ§¹ Clean build dir (safe pre-build cleanup)
        run: |
          rm -rf ${{ env.build_dir }}/* || true
          df -h

      - name: ğŸ“¥ Download toolchain artifact
        uses: actions/download-artifact@v4
        with:
          name: toolchain-${{ env.os }}-${{ matrix.device }}
          path: ${{ env.build_dir }}/toolchain/

      # --- BLOQUE: Descargar ffmpegx desde release ---
      - name: ğŸ“¥ Descargar ffmpegx desde release
        run: |
          mkdir -p .github/ffmpegx
          curl -L -o ffmpegx.zip https://github.com/roisiano/tvheadend-addon-patched-for-CoreELEC/releases/download/ffmpeg/ffmpegx-CoreELEC-Amlogic-no.zip
          unzip ffmpegx.zip -d .github/ffmpegx
          mkdir -p ${{ env.build_dir }}/install_pkg/ffmpegx-8.0.1/usr/local/bin/
          cp .github/ffmpegx/ffmpeg ${{ env.build_dir }}/install_pkg/ffmpegx-8.0.1/usr/local/bin/
          cp .github/ffmpegx/ffprobe ${{ env.build_dir }}/install_pkg/ffmpegx-8.0.1/usr/local/bin/
          chmod +x ${{ env.build_dir }}/install_pkg/ffmpegx-8.0.1/usr/local/bin/ffmpeg
          chmod +x ${{ env.build_dir }}/install_pkg/ffmpegx-8.0.1/usr/local/bin/ffprobe

      # --- BLOQUE: Descargar comskip desde release ---
      - name: ğŸ“¥ Descargar comskip desde release
        run: |
          mkdir -p .github/comskip
          curl -L -o comskip.zip https://github.com/roisiano/tvheadend-addon-patched-for-CoreELEC/releases/download/ffmpeg/comskip.zip
          unzip comskip.zip -d .github/comskip
          mkdir -p ${{ env.build_dir }}/install_pkg/comskip/usr/local/bin/
          cp .github/comskip/comskip ${{ env.build_dir }}/install_pkg/comskip/usr/local/bin/
          chmod +x ${{ env.build_dir }}/install_pkg/comskip/usr/local/bin/comskip

      - name: ğŸ” Verificar binarios disponibles
        run: |
          ${{ env.build_dir }}/install_pkg/ffmpegx-8.0.1/usr/local/bin/ffmpeg -version || echo "ffmpeg no ejecuta"
          ${{ env.build_dir }}/install_pkg/ffmpegx-8.0.1/usr/local/bin/ffprobe -version || echo "ffprobe no ejecuta"
          ${{ env.build_dir }}/install_pkg/comskip/usr/local/bin/comskip --version || echo "comskip no ejecuta"

      - name: ğŸ˜®ï¸ Patches adding ...
        run: |
          cp ${{ github.workspace }}/.github/patches/tvheadend43-newer.patch \
             ${{ github.workspace }}/${{ matrix.os }}/packages/addons/service/tvheadend43/patches/tvheadend43-100-LS.patch

      - name: ğŸ‘·ï¸ Build tvheadend addon
        run: |
          cd ${{ github.workspace }}/${{ matrix.os }}
          ARCH=${{ matrix.arch }} PROJECT=${{ matrix.project }} DEVICE=${{ matrix.device }} \
          scripts/create_addon tvheadend43 -j2

      - name: ğŸ“¤ï¸ Upload addon
        uses: actions/upload-artifact@v4
        with:
          name: tvheadend43-${{ env.os }}-${{ matrix.device }}
          path: ${{ github.workspace }}/${{ matrix.os }}/target/
          compression-level: 9


