name: CoreELEC Tvheadend Addon Build

on:
  workflow_dispatch:

jobs:
  build:
    name: CoreELEC-aarch64
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Checkout del repositorio que contiene workflow y fuentes locales
      - name: ğŸ”Œ Checkout workflow repo
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Liberar espacio en runner gratuito
      - name: ğŸ§¹ Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/lib/android "$AGENT_TOOLSDIRECTORY"
          df -h

      # 3ï¸âƒ£ Instalar dependencias
      - name: ğŸ”¨ Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            gcc g++ make git wget zip unzip xz-utils bc curl gperf \
            xsltproc xfonts-utils patchutils lzop libxml-parser-perl \
            libparse-yapp-perl openjdk-11-jre-headless openjdk-17-jre-headless rsync rename jq rdfind

      # 4ï¸âƒ£ Clonar CoreELEC (shallow clone)
      - name: ğŸ“¥ Clone CoreELEC
        run: |
          git clone --depth 1 https://github.com/CoreELEC/CoreELEC
          cd CoreELEC
          git checkout origin/coreelec-22

      # 5ï¸âƒ£ Aplicar parche dvbcsa
      - name: ğŸ˜œ Update dvbcsa
        run: |
          patch -d CoreELEC -p1 < .github/patches/up-libdvbcsa.patch

      # 6ï¸âƒ£ Configurar rutas y variables
      - name: ğŸ” Set paths
        run: |
          cd CoreELEC
          ARCH=aarch64 PROJECT=Amlogic-ce DEVICE=Amlogic-no . config/options
          echo "sources_dir=$SOURCES" >> $GITHUB_ENV
          echo "build_dir=$BUILD" >> $GITHUB_ENV

      # 7ï¸âƒ£ Cache solo de ccache
      - name: ğŸ’½ Cache ccache
        uses: actions/cache@v4
        with:
          path: ${{ env.build_dir }}/.ccache
          key: coreelec-tvheadend-ccache

      # 8ï¸âƒ£ Complementar fuentes locales si faltan
      - name: ğŸ“¦ Add fallback sources
        run: |
          mkdir -p ${{ env.sources_dir }}
          rsync -a --ignore-existing .github/sources/ ${{ env.sources_dir }}/

      # 9ï¸âƒ£ Aplicar parches de Tvheadend
      - name: ğŸ˜® Apply Tvheadend patch
        run: |
          cp .github/patches/tvheadend43-newer.patch \
             CoreELEC/packages/addons/service/tvheadend43/patches/tvheadend43-100-LS.patch

      # ğŸ”Ÿ Compilar el addon
      - name: ğŸ‘· Build addon
        run: |
          cd CoreELEC
          ARCH=aarch64 PROJECT=Amlogic-ce DEVICE=Amlogic-no scripts/create_addon tvheadend43

      # 1ï¸âƒ£1ï¸âƒ£ Subir todo el target generado
      - name: ğŸ“¤ï¸ Upload target
        uses: actions/upload-artifact@v4
        with:
          name: target-CoreELEC-Amlogic-no
          path: ${{ github.workspace }}/CoreELEC/target/
          compression-level: 9
