name: GitHub Automatic Build
on:
  workflow_dispatch:

jobs:
  tvheadend:
    name: Tvheadend-${{ matrix.os }}-${{ matrix.device }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
        - os: CoreELEC
          tags: origin/coreelec-22
          arch: aarch64
          project: Amlogic-ce
          device: Amlogic-no

    steps:
      - name: üîåÔ∏è Checkout
        uses: actions/checkout@v4

      - name: üî®Ô∏è Install base dependencies + fix gettext/libtool deps
        run: |
          sudo apt-get update && sudo apt-get install -y \
            build-essential git wget zip unzip xz-utils bc curl gperf xsltproc \
            patchutils lzop libxml-parser-perl libparse-yapp-perl \
            openjdk-11-jre-headless openjdk-17-jre-headless \
            rsync rename jq rdfind yasm nasm pkg-config \
            libtool autoconf automake xfonts-utils m4 texinfo gettext autopoint help2man
          which gettext || echo "gettext no encontrado"
          which autopoint || echo "autopoint no encontrado"
          which m4 || echo "m4 no encontrado"
          which autoconf || echo "autoconf no encontrado"
          which automake || echo "automake no encontrado"
          which libtool || echo "libtool no encontrado"

      - name: ‚úÇÔ∏è Set OS without extension
        run: echo "os=$(echo ${{ matrix.os }} | cut -d '.' -f 1)" >> $GITHUB_ENV

      - name: üì•Ô∏è Download the ${{ matrix.os }}
        run: git clone https://github.com/${{ env.os }}/${{ matrix.os }}

      - name: üìåÔ∏è ${{ matrix.os }} release tags checkout
        run: |
          cd ${{ matrix.os }}
          git checkout ${{ matrix.tags }}

      - name: üîçÔ∏è Get path
        run: |
          cd ${{ github.workspace }}/${{ matrix.os }}
          ARCH=${{ matrix.arch }} PROJECT=${{ matrix.project }} DEVICE=${{ matrix.device }} . config/options
          echo "sources_dir=$(echo ${SOURCES})" >> $GITHUB_ENV
          echo "build_dir=$(echo ${BUILD})" >> $GITHUB_ENV
          echo "project=$(echo ${DISTRONAME}-${OS_VERSION})" >> $GITHUB_ENV

      - name: üßπ Clean build dir (safe pre-build cleanup)
        run: |
          rm -rf ${{ env.build_dir }}/* || true
          df -h

      # --- BLOQUE: Descargar toolchain desde release ---
      - name: üì• Descargar toolchain desde release
        run: |
          mkdir -p ${{ env.build_dir }}/toolchain
          curl -L -o toolchain.zip https://github.com/roisiano/tvheadend-addon-patched-for-CoreELEC/releases/download/ffmpeg/toolchain-CoreELEC-Amlogic-no.zip
          unzip toolchain.zip -d ${{ env.build_dir }}/toolchain

      # --- BLOQUE: Exportar libtool del toolchain ---
      - name: üõ†Ô∏è Export toolchain libtool to PATH
        run: |
          echo "${{ env.build_dir }}/toolchain/bin" >> $GITHUB_PATH
          echo "ACLOCAL_PATH=${{ env.build_dir }}/toolchain/share/aclocal" >> $GITHUB_ENV

      # --- BLOQUE: Descargar ffmpegx desde release ---
      - name: üì• Descargar ffmpegx desde release
        run: |
          mkdir -p .github/ffmpegx
          curl -L -o ffmpegx.zip https://github.com/roisiano/tvheadend-addon-patched-for-CoreELEC/releases/download/ffmpeg/ffmpegx-CoreELEC-Amlogic-no.zip
          unzip ffmpegx.zip -d .github/ffmpegx
          mkdir -p ${{ env.build_dir }}/install_pkg/ffmpegx-8.0.1/usr/local/bin/
          cp .github/ffmpegx/ffmpeg ${{ env.build_dir }}/install_pkg/ffmpegx-8.0.1/usr/local/bin/
          cp .github/ffmpegx/ffprobe ${{ env.build_dir }}/install_pkg/ffmpegx-8.0.1/usr/local/bin/
          chmod +x ${{ env.build_dir }}/install_pkg/ffmpegx-8.0.1/usr/local/bin/ffmpeg
          chmod +x ${{ env.build_dir }}/install_pkg/ffmpegx-8.0.1/usr/local/bin/ffprobe

      # --- BLOQUE: Descargar comskip desde release ---
      - name: üì• Descargar comskip desde release
        run: |
          mkdir -p .github/comskip
          curl -L -o comskip.zip https://github.com/roisiano/tvheadend-addon-patched-for-CoreELEC/releases/download/ffmpeg/comskip.zip
          unzip comskip.zip -d .github/comskip
          mkdir -p ${{ env.build_dir }}/install_pkg/comskip/usr/local/bin/
          cp .github/comskip/comskip ${{ env.build_dir }}/install_pkg/comskip/usr/local/bin/
          chmod +x ${{ env.build_dir }}/install_pkg/comskip/usr/local/bin/comskip

      - name: üîé Verificar binarios disponibles
        run: |
          ${{ env.build_dir }}/install_pkg/ffmpegx-8.0.1/usr/local/bin/ffmpeg -version || echo "ffmpeg no ejecuta"
          ${{ env.build_dir }}/install_pkg/ffmpegx-8.0.1/usr/local/bin/ffprobe -version || echo "ffprobe no ejecuta"
          ${{ env.build_dir }}/install_pkg/comskip/usr/local/bin/comskip --version || echo "comskip no ejecuta"

      - name: üòÆÔ∏è Patches adding ...
        run: |
          cp ${{ github.workspace }}/.github/patches/tvheadend43-newer.patch \
             ${{ github.workspace }}/${{ matrix.os }}/packages/addons/service/tvheadend43/patches/tvheadend43-100-LS.patch

      - name: üë∑Ô∏è Build tvheadend addon
        run: |
          cd ${{ github.workspace }}/${{ matrix.os }}
          ARCH=${{ matrix.arch }} PROJECT=${{ matrix.project }} DEVICE=${{ matrix.device }} \
          scripts/create_addon tvheadend43 -j2

      - name: üì§Ô∏è Upload addon
        uses: actions/upload-artifact@v4
        with:
          name: tvheadend43-${{ env.os }}-${{ matrix.device }}
          path: ${{ github.workspace }}/${{ matrix.os }}/target/
          compression-level: 9

      # --- BLOQUE: Mostrar logs de fallos (100 l√≠neas) ---
      - name: üìú Mostrar primeros 100 l√≠neas de logs con FAIL
        if: failure()
        run: |
          echo "=== Logs de fallos (primeras 100 l√≠neas) ==="
          for log in $(grep -l "FAILURE" ${{ env.build_dir }}/.threads/logs/*.log | sort); do
            echo "--- $log ---"
            head -n 100 "$log"
          done

      # --- BLOQUE: Subir todos los logs como artifact ---
      - name: üì§ Upload build logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: ${{ env.build_dir }}/.threads/logs/
          compression-level: 9

