name: GitHub Automatic Build (CoreELEC 21.3 Matrix)

on:
  workflow_dispatch:

jobs:
  build:
    name: ${{ matrix.project }}-${{ matrix.arch }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          - project: Amlogic-ne
            arch: aarch64
            device: Amlogic
          - project: Amlogic-ng
            arch: arm
            device: Amlogic

    steps:
      - name: ğŸ”Œï¸ Checkout
        uses: actions/checkout@v4

      - name: ğŸ”¨ï¸ Install dependencies
        run: sudo apt-get update && sudo apt-get install gcc g++ make git wget zip unzip xz-utils bc curl gperf zip xsltproc xfonts-utils patchutils lzop libxml-parser-perl libparse-yapp-perl openjdk-11-jre-headless rsync rename jq rdfind

      - name: ğŸ“¥ï¸ Clone CoreELEC 21.3 Matrix
        run: git clone --branch coreelec-21 https://github.com/CoreELEC/CoreELEC.git

      - name: ğŸ“Œï¸ Checkout release tag
        run: |
          cd CoreELEC
          git checkout origin/coreelec-21

      - name: ğŸ§© Apply libdvbcsa patch
        run: |
          patch -d ${{ github.workspace }}/CoreELEC -p1 < ${{ github.workspace }}/.github/patches/up-libdvbcsa.patch

      - name: ğŸ§© Apply tvheadend42 patch
        run: |
          cp ${{ github.workspace }}/.github/patches/tvheadend42.patch ${{ github.workspace }}/CoreELEC/packages/addons/service/tvheadend42/patches/tvheadend42-100-LS.patch

      - name: ğŸ§© Apply tvheadend43 patch
        run: |
          cp ${{ github.workspace }}/.github/patches/tvheadend43-newer.patch ${{ github.workspace }}/CoreELEC/packages/addons/service/tvheadend43/patches/tvheadend43-100-LS.patch

      - name: ğŸ”ï¸ Get build paths
        run: |
          cd ${{ github.workspace }}/CoreELEC
          ARCH=${{ matrix.arch }} PROJECT=${{ matrix.project }} DEVICE=${{ matrix.device }} . config/options
          echo "sources_dir=$(echo ${SOURCES})" >> $GITHUB_ENV
          echo "build_dir=$(echo ${BUILD})" >> $GITHUB_ENV
          echo "project=$(echo ${DISTRONAME}-${OS_VERSION})" >> $GITHUB_ENV

      - name: ğŸ’½ï¸ Cache
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.sources_dir }}
            ${{ env.build_dir }}/.ccache
            ${{ env.build_dir }}/.ccache-local
          key: ${{ env.project }}-${{ matrix.project }}-${{ matrix.arch }}
          restore-keys: ${{ env.project }}-

      - name: ğŸ‘·ï¸ Build tvheadend42 addon
        run: |
          cd ${{ github.workspace }}/CoreELEC
          ARCH=${{ matrix.arch }} PROJECT=${{ matrix.project }} DEVICE=${{ matrix.device }} scripts/create_addon tvheadend42

      - name: ğŸ‘·ï¸ Build tvheadend43 addon
        run: |
          cd ${{ github.workspace }}/CoreELEC
          ARCH=${{ matrix.arch }} PROJECT=${{ matrix.project }} DEVICE=${{ matrix.device }} scripts/create_addon tvheadend43

      - name: ğŸ“¤ï¸ Upload compiled addons
        uses: actions/upload-artifact@v4
        with:
          name: target-${{ matrix.project }}-${{ matrix.arch }}
          path: ${{ github.workspace }}/CoreELEC/target/
          compression-level: 9

      - name: ğŸ§¾ Guardar logs de errores si falla
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: logs-de-errores-${{ matrix.project }}-${{ matrix.arch }}
          path: |
            ${{ env.build_dir }}/.threads/logs/92.log
            ${{ env.build_dir }}/.threads/logs/99.log
            ${{ env.build_dir }}/.threads/logs/100.log

