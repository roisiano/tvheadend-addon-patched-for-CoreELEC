name: GitHub Automatic Build (CoreELEC 21.3 Matrix)

on:
  workflow_dispatch:

jobs:
  omega:
    name: Omega-${{ matrix.device }}-${{ matrix.arch }}
    runs-on: ubuntu-24.04
    continue-on-error: true

    strategy:
      matrix:
        include:
          - device: "AMLGX"
            arch: arm
            project: "Amlogic"
          - device: "AMLGX"
            arch: aarch64
            project: "Amlogic"

    steps:
      - name: ğŸ”Œï¸ Checkout
        uses: actions/checkout@v4

      - name: ğŸ”¨ï¸ Install dependencies
        run: sudo apt-get update && sudo apt-get install gcc g++ make git wget zip unzip xz-utils bc curl gperf zip xsltproc xfonts-utils patchutils lzop libxml-parser-perl libparse-yapp-perl openjdk-11-jre-headless rsync rename jq rdfind

      - name: ğŸ“¥ï¸ Clone CoreELEC 21.3 Matrix
        run: git clone --branch coreelec-21 https://github.com/CoreELEC/CoreELEC.git

      - name: ğŸ“Œï¸ Checkout release tag
        run: |
          cd CoreELEC
          git checkout origin/coreelec-21

      - name: ğŸ§© Apply libdvbcsa patch
        run: |
          patch -d ${{ github.workspace }}/CoreELEC -p1 < ${{ github.workspace }}/.github/patches/up-libdvbcsa.patch

      - name: ğŸ§© Apply tvheadend42 patch
        run: |
          cp ${{ github.workspace }}/.github/patches/tvheadend42.patch ${{ github.workspace }}/CoreELEC/packages/addons/service/tvheadend42/patches/tvheadend42-100-LS.patch

      - name: ğŸ§© Apply tvheadend43 patch
        run: |
          cp ${{ github.workspace }}/.github/patches/tvheadend43-new.patch ${{ github.workspace }}/CoreELEC/packages/addons/service/tvheadend43/patches/tvheadend43-100-LS.patch

      - name: ğŸ”ï¸ Get build paths
        run: |
          cd ${{ github.workspace }}/CoreELEC
          ARCH=${{ matrix.arch }} PROJECT=${{ matrix.project }} DEVICE=${{ matrix.device }} . config/options
          echo "sources_dir=$(echo ${SOURCES})" >> $GITHUB_ENV
          echo "build_dir=$(echo ${BUILD})" >> $GITHUB_ENV
          echo "project=$(echo ${DISTRONAME}-${OS_VERSION})" >> $GITHUB_ENV

      - name: ğŸ¤”ï¸ Add local sources if needed
        run: |
          if [ -d ${{ github.workspace }}/.github/sources ] && [ ! -d ${{ env.sources_dir }} ]; then
            ln -s ${{ github.workspace }}/.github/sources ${{ env.sources_dir }}
          fi

      - name: ğŸ’½ï¸ Cache
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.sources_dir }}
            ${{ env.build_dir }}/.ccache
            ${{ env.build_dir }}/.ccache-local
          key: ${{ env.project }}-${{ matrix.device }}-${{ matrix.arch }}
          restore-keys: ${{ env.project }}-

      - name: ğŸ‘·ï¸ Build tvheadend addons
        run: |
          cd ${{ github.workspace }}/CoreELEC
          ARCH=${{ matrix.arch }} PROJECT=${{ matrix.project }} DEVICE=${{ matrix.device }} scripts/create_addon tvheadend42 tvheadend43

      - name: ğŸ“¤ï¸ Upload compiled addons
        uses: actions/upload-artifact@v4
        with:
          name: Omega-${{ matrix.device }}-${{ matrix.arch }}-target
          path: ${{ github.workspace }}/CoreELEC/target/
          if-no-files-found: error

      - name: ğŸ§¾ Guardar todos los logs de errores si falla
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: logs-de-errores-${{ matrix.device }}-${{ matrix.arch }}
          path: ${{ env.build_dir }}/.threads/logs/*.log


