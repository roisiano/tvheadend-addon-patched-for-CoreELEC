name: GitHub Automatic Build (CoreELEC 21.3 Matrix)

on:
  workflow_dispatch:

jobs:
  omega:
    name: Omega-${{ matrix.device }}-${{ matrix.arch }}
    runs-on: ubuntu-24.04
    continue-on-error: true

strategy:
  matrix:
    include:
      - device: "AMLGX"
        arch: arm
        project: "Amlogic"
      - device: "AMLGX"
        arch: aarch64
        project: "Amlogic"

    steps:
      - name: üîåÔ∏è Checkout
        uses: actions/checkout@v4

      - name: üî®Ô∏è Install dependencies
        run: sudo apt-get update && sudo apt-get install gcc g++ make git wget zip unzip xz-utils bc curl gperf zip xsltproc xfonts-utils patchutils lzop libxml-parser-perl libparse-yapp-perl openjdk-11-jre-headless rsync rename jq rdfind

      - name: üì•Ô∏è Clone CoreELEC 21.3 Matrix
        run: git clone --branch coreelec-21 https://github.com/CoreELEC/CoreELEC.git

      - name: üìåÔ∏è Checkout release tag
        run: |
          cd CoreELEC
          git checkout origin/coreelec-21

      - name: üß© Apply libdvbcsa patch
        run: |
          patch -d ${{ github.workspace }}/CoreELEC -p1 < ${{ github.workspace }}/.github/patches/up-libdvbcsa.patch

      - name: üß© Apply tvheadend42 patch
        run: |
          cp ${{ github.workspace }}/.github/patches/tvheadend42.patch ${{ github.workspace }}/CoreELEC/packages/addons/service/tvheadend42/patches/tvheadend42-100-LS.patch

      - name: üß© Apply tvheadend43 patch
        run: |
          cp ${{ github.workspace }}/.github/patches/tvheadend43-newer.patch ${{ github.workspace }}/CoreELEC/packages/addons/service/tvheadend43/patches/tvheadend43-100-LS.patch

      - name: üîçÔ∏è Get build paths
        run: |
          cd ${{ github.workspace }}/CoreELEC
          ARCH=${{ matrix.arch }} PROJECT=Amlogic DEVICE=Amlogic . config/options
          echo "sources_dir=$(echo ${SOURCES})" >> $GITHUB_ENV
          echo "build_dir=$(echo ${BUILD})" >> $GITHUB_ENV
          echo "project=$(echo ${DISTRONAME}-${OS_VERSION})" >> $GITHUB_ENV

      - name: ü§îÔ∏è Add local sources if needed
        run: |
          if [ -d ${{ github.workspace }}/.github/sources ] && [ ! -d ${{ env.sources_dir }} ]; then
            ln -s ${{ github.workspace }}/.github/sources ${{ env.sources_dir }}
          fi

      - name: üíΩÔ∏è Cache
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.sources_dir }}
            ${{ env.build_dir }}/.ccache
            ${{ env.build_dir }}/.ccache-local
          key: ${{ env.project }}-${{ matrix.device }}-${{ matrix.arch }}
          restore-keys: ${{ env.project }}-

      - name: üë∑Ô∏è Build tvheadend42 addon
        run: |
          cd ${{ github.workspace }}/CoreELEC
          ARCH=${{ matrix.arch }} PROJECT=Amlogic DEVICE=Amlogic scripts/create_addon tvheadend42

      - name: üë∑Ô∏è Build tvheadend43 addon
        run: |
          cd ${{ github.workspace }}/CoreELEC
          ARCH=${{ matrix.arch }} PROJECT=Amlogic DEVICE=Amlogic scripts/create_addon tvheadend43

      - name: üì§Ô∏è Upload compiled addons
        uses: actions/upload-artifact@v4
        with:
          name: target-${{ matrix.device }}-${{ matrix.arch }}
          path: ${{ github.workspace }}/CoreELEC/target/
          compression-level: 9

      - name: üßæ Guardar logs de errores si falla
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: logs-de-errores-${{ matrix.device }}-${{ matrix.arch }}
          path: |
            ${{ env.build_dir }}/.threads/logs/92.log
            ${{ env.build_dir }}/.threads/logs/99.log
            ${{ env.build_dir }}/.threads/logs/100.log


