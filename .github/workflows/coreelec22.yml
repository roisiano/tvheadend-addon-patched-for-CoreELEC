name: Build Patched Tvheadend43 (ICAM)

on:
  workflow_dispatch:

jobs:
  build-addon:
    runs-on: ubuntu-22.04

    steps:
      - name: 🔌 Checkout repo
        uses: actions/checkout@v4

      - name: 🔧 Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            gcc g++ make git wget unzip zip patchutils autoconf automake libtool \
            pkg-config cmake bison flex gettext python3

      - name: 📥 Download Tvheadend source
        run: |
          wget https://github.com/tvheadend/tvheadend/archive/f1c460feb.tar.gz -O tvh-src.tar.gz
          mkdir tvh-src && tar --strip=1 -xzf tvh-src.tar.gz -C tvh-src

      - name: 📥 Apply patches
        run: |
          cp .github/patches/up-libdvbcsa.patch tvh-src/
          cp .github/patches/tvheadend43-newer.patch tvh-src/
          cd tvh-src
          git init
          git config user.name "CI"
          git config user.email "ci@example.com"
          git add .
          git commit -m "base"
          patch -p1 < up-libdvbcsa.patch
          patch -p1 < tvheadend43-newer.patch

      - name: 🛠️ Build patched tvheadend
        run: |
          cd tvh-src
          ./configure --prefix=/usr \
                      --arch=aarch64 \
                      --cpu=cortex-a53 \
                      --enable-avahi \
                      --enable-bundle \
                      --disable-dbus_1 \
                      --enable-dvbcsa \
                      --disable-dvben50221 \
                      --disable-dvbscan \
                      --enable-hdhomerun_client \
                      --disable-hdhomerun_static \
                      --enable-epoll \
                      --enable-inotify \
                      --enable-pngquant \
                      --disable-libmfx_static \
                      --disable-nvenc \
                      --disable-uriparser \
                      --enable-tvhcsa \
                      --enable-trace \
                      --nowerror \
                      --disable-bintray_cache \
                      --python=/usr/bin/python3
          make -j$(nproc) tvheadend

      - name: 📥 Download official addon
        run: |
          wget https://raw.githubusercontent.com/roisiano/tvheadend-addon-patched-for-CoreELEC/refs/heads/main/.github/sources/service.tvheadend43-22.0.4.3.zip -O addon.zip
          unzip addon.zip -d addon

      - name: 🔁 Replace tvheadend binary
        run: |
          cp tvh-src/tvheadend addon/service.tvheadend43/bin/tvheadend
          chmod +x addon/service.tvheadend43/bin/tvheadend

      - name: 📦 Repack patched addon
        run: |
          cd addon
          zip -r ../service.tvheadend43-22.0.4.3-icam.zip service.tvheadend43

      - name: 📤 Upload patched addon
        uses: actions/upload-artifact@v4
        with:
          name: tvheadend43-icam
          path: service.tvheadend43-22.0.4.3-icam.zip

      - name: 📄 Upload build logs
        if: always()
        run: |
          mkdir -p logs
          cp tvh-src/config.log logs/ || true
          cp tvh-src/Makefile logs/ || true
        continue-on-error: true

      - name: 📤 Upload logs artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: logs/
          if-no-files-found: warn



