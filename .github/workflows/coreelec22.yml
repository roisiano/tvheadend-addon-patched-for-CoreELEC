  coreelec22:
    name: CoreELEC22-Amlogic-no-aarch64
    runs-on: ubuntu-24.04
    continue-on-error: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install gcc make git unzip wget xz-utils bc gperf zip unzip g++ xsltproc xfonts-utils patchutils lzop libxml-parser-perl libparse-yapp-perl rename jq

      - name: Download CoreELEC
        run: git clone https://github.com/CoreELEC/CoreELEC

      - name: CoreELEC checkout (coreelec-22)
        run: |
          cd CoreELEC
          git checkout coreelec-22

      - name: Adding sources for download errors...
        run: |
          if [ -d ${{ github.workspace }}/.github/sources ] && [ ! -d ${{ github.workspace }}/CoreELEC/sources ]; then
            ln -s ${{ github.workspace }}/.github/sources ${{ github.workspace }}/CoreELEC/sources
          fi

      - name: Patches adding...
        run: |
          mkdir -p ${{ github.workspace }}/CoreELEC/packages/addons/addon-depends/libdvbcsa/patches
          cp ${{ github.workspace }}/.github/patches/libdvbcsa.patch ${{ github.workspace }}/CoreELEC/packages/addons/addon-depends/libdvbcsa/patches/libdvbcsa-100-LS.patch
          cp ${{ github.workspace }}/.github/patches/tvheadend42.patch ${{ github.workspace }}/CoreELEC/packages/addons/service/tvheadend42/patches/tvheadend42-100-LS.patch
          cp ${{ github.workspace }}/.github/patches/tvheadend43-new.patch ${{ github.workspace }}/CoreELEC/packages/addons/service/tvheadend43/patches/tvheadend43-100-LS.patch

      - name: Building addons for CoreELEC 22
        run: cd ${{ github.workspace }}/CoreELEC && ARCH=aarch64 PROJECT=Amlogic-ce DEVICE=Amlogic-no scripts/create_addon tvheadend42 tvheadend43

      - name: Upload target
        uses: actions/upload-artifact@v4
        id: upload-artifact
        continue-on-error: true
        with:
          name: CoreELEC22-Amlogic-no-aarch64-target
          path: ${{ github.workspace }}/CoreELEC/target/
          if-no-files-found: error
