name: Build Patched Tvheadend43 (CoreELEC)

on:
  workflow_dispatch:

jobs:
  build-addon:
    runs-on: ubuntu-22.04

    steps:
      - name: ğŸ”Œ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            gcc g++ make git wget unzip zip patchutils rsync pkg-config autoconf automake libtool \
            xfonts-utils rdfind libparse-yapp-perl gperf xsltproc libxml-parser-perl lzop \
            python3 bison flex gettext cmake gawk texinfo

      - name: ğŸ“¥ Clone CoreELEC
        run: |
          git clone https://github.com/CoreELEC/CoreELEC.git
          cd CoreELEC
          git checkout coreelec-22

      - name: ğŸ” Verificar clonado
        run: ls -l CoreELEC

      - name: ğŸ“Œ Apply libdvbcsa patch
        run: |
          mkdir -p CoreELEC/packages/addons/addon-depends/libdvbcsa/patches
          cp patches/up-libdvbcsa.patch \
             CoreELEC/packages/addons/addon-depends/libdvbcsa/patches/001-up-libdvbcsa.patch

      - name: ğŸ˜® Add tvheadend patch
        run: |
          mkdir -p CoreELEC/packages/addons/service/tvheadend43/patches
          cp patches/tvheadend43-newer.patch \
             CoreELEC/packages/addons/service/tvheadend43/patches/tvheadend43-100-LS.patch

      - name: ğŸ› ï¸ Build libdvbcsa
        working-directory: CoreELEC
        run: |
          DEVICE=Amlogic-no scripts/build libdvbcsa > ../build-libdvbcsa.log 2>&1

      - name: ğŸ§± Create tvheadend43 addon
        working-directory: CoreELEC
        run: |
          DEVICE=Amlogic-no scripts/create_addon tvheadend43 > ../build-addon.log 2>&1

      - name: ğŸ“¤ Upload build logs
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            build-libdvbcsa.log
            build-addon.log

      - name: ğŸ“¦ Buscar addon generado
        run: |
          ADDON_ZIP=$(find CoreELEC -name "service.tvheadend43-*.zip" | head -n 1)
          if [ -f "$ADDON_ZIP" ]; then
            echo "Addon encontrado: $ADDON_ZIP"
            cp "$ADDON_ZIP" tvheadend43-patched.zip
          else
            echo "âŒ No se encontrÃ³ el addon zip"
            exit 1
          fi

      - name: ğŸ“¤ Subir addon parcheado
        uses: actions/upload-artifact@v4
        with:
          name: tvheadend43-patched
          path: tvheadend43-patched.zip

