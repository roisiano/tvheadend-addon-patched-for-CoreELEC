name: Check Sources Availability

on:
  workflow_dispatch:

jobs:
  check-sources:
    runs-on: ubuntu-22.04
    steps:
      - name: üîå Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üì• Clone CoreELEC
        run: git clone https://github.com/CoreELEC/CoreELEC --branch coreelec-22 --depth 1

      - name: üìå Get build paths
        run: |
          cd CoreELEC
          ARCH=aarch64 PROJECT=Amlogic-ce DEVICE=Amlogic-no . config/options
          echo "sources_dir=${SOURCES}" >> $GITHUB_ENV

      - name: üîç Check sources availability (full expansion)
        run: |
          MISSING=0
          echo "üîé Comprobando fuentes necesarias..."
          for PKG in \
            "packages/multimedia/ffmpeg/package.mk:FFmpeg" \
            "packages/addons/service/tvheadend42/package.mk:tvheadend42" \
            "packages/addons/service/tvheadend43/package.mk:tvheadend43"
          do
            FILE_PATH="${PKG%%:*}"
            NAME="${PKG##*:}"

            (
              cd CoreELEC
              # Cargar entorno de compilaci√≥n
              ARCH=aarch64 PROJECT=Amlogic-ce DEVICE=Amlogic-no . config/options
              # Cargar el package.mk y cualquier include que tenga
              source "$FILE_PATH"
              URL=$(eval echo "$PKG_URL")
              FILE=$(basename "$URL")
              echo "‚û° $NAME ‚Üí $URL"
              if [ -n "$URL" ] && curl --head --silent --fail "$URL" >/dev/null; then
                echo "   ‚úÖ Disponible online"
              elif [ -f "${{ github.workspace }}/sources/$FILE" ]; then
                echo "   ‚úÖ Encontrado en sources locales"
              else
                echo "   ‚ùå NO disponible ‚Üí Paquete: $NAME | URL: $URL"
                exit 99
              fi
            )
            if [ "$?" -eq 99 ]; then
              MISSING=$((MISSING+1))
            fi
          done

          if [ "$MISSING" -gt 0 ]; then
            echo "‚ùå $MISSING paquete(s) con fuentes no disponibles"
            exit 1
          else
            echo "üéâ Todo OK: todas las fuentes est√°n disponibles"
          fi
