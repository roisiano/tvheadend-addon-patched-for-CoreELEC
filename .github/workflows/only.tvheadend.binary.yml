name: Build Patched Tvheadend43

on:
  workflow_dispatch:

jobs:
  build-tvheadend43:
    runs-on: ubuntu-22.04

    steps:
      - name: ğŸ”Œ Checkout repository
        uses: actions/checkout@v4

      # 1ï¸âƒ£ Descargar addon oficial
      - name: ğŸ“¥ Download official Tvheadend43 addon
        run: |
          wget https://raw.githubusercontent.com/roisiano/tvheadend-addon-patched-for-CoreELEC/refs/heads/main/.github/sources/service.tvheadend43-22.0.4.3.zip -O tvh-official.zip
          unzip tvh-official.zip -d tvh-official

      # 2ï¸âƒ£ Descargar y preparar fuentes de Tvheadend
      - name: ğŸ“¥ Prepare build sources
        run: |
          wget https://github.com/tvheadend/tvheadend/archive/f1c460feb.tar.gz -O tvh-src.tar.gz
          mkdir tvh-src && tar --strip=1 -xzf tvh-src.tar.gz -C tvh-src
          cp ${{ github.workspace }}/.github/patches/tvheadend43-new.patch tvh-src/
          cp ${{ github.workspace }}/.github/patches/up-libdvbcsa.patch tvh-src/

      # 3ï¸âƒ£ Aplicar parches
      - name: ğŸ§© Apply patches
        run: |
          cd tvh-src
          git init
          git config user.name "CI"
          git config user.email "ci@example.com"
          git add .
          git commit -m "initial commit"
          patch -p1 < tvheadend43-new.patch
          patch -p1 < up-libdvbcsa.patch

      # 4ï¸âƒ£ Compilar solo tvheadend
      - name: ğŸ› ï¸ Build Tvheadend
        run: |
          cd tvh-src
          ./configure --prefix=/usr --enable-avahi --enable-dvbcsa
          make -j"$(nproc)" tvheadend

      # 5ï¸âƒ£ Sustituir binario en el addon oficial
      - name: ğŸ“‚ Replace tvheadend binary in addon
        run: |
          cp tvh-src/tvheadend tvh-official/service.tvheadend43/bin/tvheadend
          chmod +x tvh-official/service.tvheadend43/bin/tvheadend

      # 6ï¸âƒ£ Empaquetar addon parcheado
      - name: ğŸ“¦ Zip patched addon
        run: |
          cd tvh-official
          zip -r ../tvheadend43-patched.zip service.tvheadend43

      # 7ï¸âƒ£ Subir artefacto final
      - name: ğŸ“¤ Upload patched addon
        uses: actions/upload-artifact@v4
        with:
          name: tvheadend43-patched
          path: tvheadend43-patched.zip

      - name: â¬†ï¸ Upload build logs
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: build-logs



