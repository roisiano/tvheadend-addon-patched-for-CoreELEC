name: Injerto TVH parcheado

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: 🔌 Checkout
        uses: actions/checkout@v4

      - name: 🔨 Instalar deps mínimas
        run: |
          sudo apt-get update && sudo apt-get install -y \
          gcc g++ make git wget unzip zip patchutils rsync

      - name: 📥 Descargar addon oficial
        run: |
          mkdir official
          wget -O official/addon.zip \
            https://raw.githubusercontent.com/roisiano/tvheadend-addon-patched-for-CoreELEC/refs/heads/main/.github/sources/service.tvheadend43-22.0.4.3.zip
          unzip official/addon.zip -d official/addon

      - name: 📥 Clonar CoreELEC
        run: git clone https://github.com/CoreELEC/CoreELEC

      - name: 📌 Checkout coreelec-22
        run: |
          cd CoreELEC
          git fetch --all
          git checkout coreelec-22

      - name: 😜 Aplicar parche libdvbcsa
        run: |
          patch -d ${{ github.workspace }}/CoreELEC -p1 \
            < ${{ github.workspace }}/.github/patches/up-libdvbcsa.patch

      - name: 📁 Añadir parche tvheadend
        run: |
          mkdir -p ${{ github.workspace }}/CoreELEC/packages/addons/service/tvheadend43/patches
          cp ${{ github.workspace }}/.github/patches/tvheadend43-new.patch \
             ${{ github.workspace }}/CoreELEC/packages/addons/service/tvheadend43/patches/tvheadend43-100-LS.patch

      - name: 🔍 Obtener rutas build
        run: |
          cd ${{ github.workspace }}/CoreELEC
          ARCH=aarch64 PROJECT=Amlogic-ce DEVICE=Amlogic-no . config/options
          echo "sources_dir=${SOURCES}" >> $GITHUB_ENV
          echo "build_dir=${BUILD}" >> $GITHUB_ENV

      - name: 🤔 Añadir sources manualmente si hace falta
        run: |
          if [ -d ${{ github.workspace }}/.github/sources ] && [ ! -d ${{ env.sources_dir }} ]; then
            ln -s ${{ github.workspace }}/.github/sources ${{ env.sources_dir }}
          fi

      - name: 👷 Compilar SOLO binario tvheadend
        run: |
          cd ${{ github.workspace }}/CoreELEC
          ARCH=aarch64 PROJECT=Amlogic-ce DEVICE=Amlogic-no \
            make -C packages/addons/service/tvheadend43 tvheadend

      - name: 🔄 Sustituir binario en addon oficial
        run: |
          cp ${{ env.build_dir }}/tvheadend43*/.install_pkg/usr/bin/tvheadend \
             official/addon/bin/tvheadend

      - name: 🗜 Reempaquetar addon final
        run: |
          cd official/addon
          zip -rFS9 ../../service.tvheadend43-22.0.4.3-icam.zip *

      - name: 📤 Subir addon final
        uses: actions/upload-artifact@v4
        with:
          name: tvheadend43-icam
          path: service.tvheadend43-22.0.4.3-icam.zip
