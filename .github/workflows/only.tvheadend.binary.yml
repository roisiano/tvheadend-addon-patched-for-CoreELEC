name: Build Patched Tvheadend43

on:
  workflow_dispatch:

jobs:
  build-tvheadend43:
    runs-on: ubuntu-22.04

    steps:
      - name: ğŸ”Œ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download official Tvheadend43 addon
        run: |
          wget https://raw.githubusercontent.com/roisiano/tvheadend-addon-patched-for-CoreELEC/refs/heads/main/.github/sources/service.tvheadend43-22.0.4.3.zip -O tvh-official.zip
          unzip tvh-official.zip -d tvh-official

      - name: ğŸ“¥ Prepare build sources
        run: |
          wget https://github.com/tvheadend/tvheadend/archive/f1c460feb.tar.gz -O tvh-src.tar.gz
          mkdir tvh-src && tar --strip=1 -xzf tvh-src.tar.gz -C tvh-src
          cp ${{ github.workspace }}/.github/patches/tvheadend43-new.patch tvh-src/
          cp ${{ github.workspace }}/.github/patches/up-libdvbcsa.patch tvh-src/

      - name: ğŸ§© Apply patches
        run: |
          cd tvh-src
          git init
          git config user.name "CI"
          git config user.email "ci@example.com"
          git add .
          git commit -m "initial commit"
          git apply tvheadend43-new.patch
          git apply up-libdvbcsa.patch

      - name: ğŸ› ï¸ Build Tvheadend with logs
        run: |
          mkdir -p build-logs
          cd tvh-src
          ./configure --prefix=/usr --enable-avahi --enable-dvbcsa > ../build-logs/configure.log 2>&1
          make -j"$(nproc)" > ../build-logs/make.log 2>&1

      - name: ğŸ“‚ Copy patched binary to addon
        run: |
          mkdir -p tvh-official/service.tvheadend43/bin
          cp tvh-src/tvheadend tvh-official/service.tvheadend43/bin/

      - name: ğŸ“ List final files
        run: |
          tree tvh-official > build-logs/final-tree.log

      - name: ğŸ“¦ Zip patched addon
        run: |
          zip -r tvheadend43-patched.zip tvh-official/service.tvheadend43

      - name: ğŸ“¤ Upload patched addon
        uses: actions/upload-artifact@v4
        with:
          name: tvheadend43-patched
          path: tvheadend43-patched.zip

      - name: â¬†ï¸ Upload build logs
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: build-logs



