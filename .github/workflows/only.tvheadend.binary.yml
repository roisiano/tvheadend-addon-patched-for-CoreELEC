name: TVH parcheado r√°pido (CoreELEC cacheado)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Instalar deps
        run: sudo apt-get update && sudo apt-get install -y gcc g++ make git wget unzip zip patchutils rsync pkg-config autoconf automake libtool

      - name: Cache CoreELEC build y sources
        uses: actions/cache@v4
        with:
          path: |
            CoreELEC/build.*
            CoreELEC/sources
          key: coreelec22-${{ runner.os }}-${{ hashFiles('.github/patches/*.patch') }}
          restore-keys: |
            coreelec22-${{ runner.os }}-

      - name: Clonar CoreELEC si no existe
        run: |
          if [ ! -d CoreELEC ]; then
            git clone https://github.com/CoreELEC/CoreELEC
            cd CoreELEC
            git checkout coreelec-22
          fi

      - name: Preparar toolchain si no existe
        run: |
          cd CoreELEC
          if [ ! -d build.* ]; then
            ARCH=aarch64 PROJECT=Amlogic-ce DEVICE=Amlogic-no make image
          fi

      - name: Aplicar parches
        run: |
          cd CoreELEC
          patch -p1 < ../.github/patches/up-libdvbcsa.patch
          mkdir -p packages/addons/service/tvheadend43/patches
          cp ../.github/patches/tvheadend43-new.patch \
             packages/addons/service/tvheadend43/patches/tvheadend43-100-LS.patch

      - name: Recompilar solo libdvbcsa y tvheadend43
        run: |
          cd CoreELEC
          ARCH=aarch64 PROJECT=Amlogic-ce DEVICE=Amlogic-no scripts/build libdvbcsa
          ARCH=aarch64 PROJECT=Amlogic-ce DEVICE=Amlogic-no scripts/build tvheadend43

      - name: Descargar addon oficial
        run: |
          mkdir official
          wget -O official/addon.zip https://.../service.tvheadend43-22.0.4.3.zip
          unzip official/addon.zip -d official/addon

      - name: Sustituir binario
        run: |
          cp CoreELEC/build.*/*tvheadend43*/.install_pkg/usr/bin/tvheadend \
             official/addon/bin/tvheadend

      - name: Reempaquetar addon
        run: |
          cd official/addon
          zip -rFS9 ../../service.tvheadend43-22.0.4.3-icam.zip *

      - name: Subir artefacto
        uses: actions/upload-artifact@v4
        with:
          name: tvheadend43-icam
          path: service.tvheadend43-22.0.4.3-icam.zip




