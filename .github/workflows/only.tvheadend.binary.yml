name: Build Patched TVH43 Addon

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: 🔌 Checkout repo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: 📥 Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential pkg-config git \
          libavcodec-dev libavformat-dev libavutil-dev libssl-dev \
          bzip2 wget autoconf automake libtool patch dos2unix unzip zip

    - name: 📥 Download official addon
      run: |
        wget https://raw.githubusercontent.com/roisiano/tvheadend-addon-patched-for-CoreELEC/refs/heads/main/.github/sources/service.tvheadend43-22.0.4.3.zip -O addon-official.zip
        unzip addon-official.zip -d addon-work

    - name: 📥 Clone Tvheadend sources
      run: |
        git clone https://github.com/tvheadend/tvheadend.git tvh-src
        cd tvh-src
        git fetch --depth=1 origin f1c460feb
        git checkout f1c460feb

    - name: ✍️ Apply patches
      run: |
        cd tvh-src
        dos2unix ${{ github.workspace }}/.github/patches/up-libdvbcsa.patch
        patch -p1 < ${{ github.workspace }}/.github/patches/up-libdvbcsa.patch
        dos2unix ${{ github.workspace }}/.github/patches/tvheadend43-new.patch
        patch -p1 < ${{ github.workspace }}/.github/patches/tvheadend43-new.patch

    - name: 🔨 Build tvheadend
      run: |
        cd tvh-src
        ./configure --prefix=/usr --enable-libav
        make -j"$(nproc)" | tee build.log
        mkdir -p ../build-logs
        cp build.log ../build-logs/tvheadend-build.log || true

    - name: 🔄 Replace binary in addon
      run: |
        cp tvh-src/build.linux/tvheadend addon-work/service.tvheadend43/bin/tvheadend

    - name: 📦 Repack addon
      run: |
        cd addon-work
        zip -r ../service.tvheadend43-22.0.4.3-patched.zip *

    - name: ⬆️ Upload addon artifact
      uses: actions/upload-artifact@v4
      with:
        name: service.tvheadend43-22.0.4.3-patched
        path: service.tvheadend43-22.0.4.3-patched.zip

    - name: ⬆️ Upload build logs
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: build-logs



