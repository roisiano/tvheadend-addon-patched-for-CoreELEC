name: Injerto TVH parcheado (toolchain externa)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: 游댋 Checkout
        uses: actions/checkout@v4

      - name: 游댣 Instalar deps m칤nimas
        run: |
          sudo apt-get update && sudo apt-get install -y \
          gcc g++ make git wget unzip zip patchutils rsync pkg-config

      - name: 游닌 Descargar addon oficial
        run: |
          mkdir official
          wget -O official/addon.zip \
            https://raw.githubusercontent.com/roisiano/tvheadend-addon-patched-for-CoreELEC/refs/heads/main/.github/sources/service.tvheadend43-22.0.4.3.zip
          unzip official/addon.zip -d official/addon

      - name: 游닌 Clonar CoreELEC (solo para toolchain)
        run: git clone https://github.com/CoreELEC/CoreELEC

      - name: 游늷 Checkout coreelec-22
        run: |
          cd CoreELEC
          git fetch --all
          git checkout coreelec-22

      - name: 丘뙖잺 Construir toolchain
        run: |
          cd CoreELEC
          ARCH=aarch64 PROJECT=Amlogic-ce DEVICE=Amlogic-no make toolchain

      - name: 游닌 Descargar c칩digo fuente tvheadend
        run: |
          mkdir tvh-src
          cd tvh-src
          # Usa la misma versi칩n que el addon oficial
          wget https://github.com/tvheadend/tvheadend/archive/refs/tags/v4.3.zip -O tvh.zip
          unzip tvh.zip
          mv tvheadend-* src

      - name: 游땦 Aplicar parches
        run: |
          patch -d tvh-src/src -p1 < .github/patches/up-libdvbcsa.patch
          patch -d tvh-src/src -p1 < .github/patches/tvheadend43-new.patch

      - name: 游농 Compilar tvheadend con toolchain CoreELEC
        run: |
          export PATH="${{ github.workspace }}/CoreELEC/build.CoreELEC-Amlogic-no.aarch64-22/toolchain/bin:$PATH"
          export CC=aarch64-libreelec-linux-gnu-gcc
          export CXX=aarch64-libreelec-linux-gnu-g++
          export PKG_CONFIG_PATH="${{ github.workspace }}/CoreELEC/build.CoreELEC-Amlogic-no.aarch64-22/toolchain/aarch64-libreelec-linux-gnu/sysroot/usr/lib/pkgconfig"
          cd tvh-src/src
          ./configure --arch=arm64 --platform=linux --prefix=/usr --disable-avahi --disable-ffmpeg_static
          make -j$(nproc)

      - name: 游댃 Sustituir binario en addon oficial
        run: |
          cp tvh-src/src/build.linux/tvheadend official/addon/bin/tvheadend

      - name: 游딒 Reempaquetar addon final
        run: |
          cd official/addon
          zip -rFS9 ../../service.tvheadend43-22.0.4.3-icam.zip *

      - name: 游닋 Subir addon final
        uses: actions/upload-artifact@v4
        with:
          name: tvheadend43-icam
          path: service.tvheadend43-22.0.4.3-icam.zip


