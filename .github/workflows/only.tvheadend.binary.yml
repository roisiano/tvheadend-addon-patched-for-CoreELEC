name: Injerto TVH parcheado (solo binario tvheadend, toolchain rápida)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: 🔌 Checkout
        uses: actions/checkout@v4

      - name: 🔨 Instalar deps mínimas
        run: |
          sudo apt-get update && sudo apt-get install -y \
          gcc g++ make git wget unzip zip patchutils rsync pkg-config

      - name: 📥 Descargar toolchain CoreELEC precompilada
        run: |
          wget https://github.com/CoreELEC/CoreELEC/releases/download/21.0-Omega/toolchain-aarch64-g12.tar.xz
          tar -xf toolchain-aarch64-g12.tar.xz
          echo "$PWD/toolchain/bin" >> $GITHUB_PATH

      - name: 📥 Descargar addon oficial
        run: |
          mkdir official
          wget -O official/addon.zip \
            https://raw.githubusercontent.com/roisiano/tvheadend-addon-patched-for-CoreELEC/refs/heads/main/.github/sources/service.tvheadend43-22.0.4.3.zip
          unzip official/addon.zip -d official/addon

      - name: 📥 Clonar fuente tvheadend
        run: |
          git clone --branch release/4.3 https://github.com/tvheadend/tvheadend.git

      - name: 😜 Aplicar parche libdvbcsa
        run: |
          patch -d ${{ github.workspace }}/tvheadend -p1 \
            < ${{ github.workspace }}/.github/patches/up-libdvbcsa.patch

      - name: 📁 Aplicar parche tvheadend ICAM
        run: |
          patch -d ${{ github.workspace }}/tvheadend -p1 \
            < ${{ github.workspace }}/.github/patches/tvheadend43-new.patch

      - name: 👷 Compilar tvheadend con toolchain
        run: |
          cd tvheadend
          ./configure --arch=arm64 --platform=linux --disable-avahi --disable-ffmpeg_static
          make -j$(nproc)

      - name: 🔄 Sustituir binario en addon oficial
        run: |
          cp tvheadend/build.linux/tvheadend \
             official/addon/bin/tvheadend

      - name: 🗜 Reempaquetar addon final
        run: |
          cd official/addon
          zip -rFS9 ../../service.tvheadend43-22.0.4.3-icam.zip *

      - name: 📤 Subir addon final
        uses: actions/upload-artifact@v4
        with:
          name: tvheadend43-icam
          path: service.tvheadend43-22.0.4.3-icam.zip


