name: Build Patched Tvheadend43

on:
  workflow_dispatch:

jobs:
  build-tvheadend43:
    runs-on: ubuntu-22.04

    steps:
      - name: 🔌 Checkout repository
        uses: actions/checkout@v4

      # 1️⃣ Descargar addon oficial
      - name: 📥 Download official Tvheadend43 addon
        run: |
          wget https://raw.githubusercontent.com/roisiano/tvheadend-addon-patched-for-CoreELEC/refs/heads/main/.github/sources/service.tvheadend43-22.0.4.3.zip -O tvh-official.zip
          unzip tvh-official.zip -d tvh-official

      # 2️⃣ Descargar y preparar fuentes de Tvheadend
      - name: 📥 Prepare build sources
        run: |
          wget https://github.com/tvheadend/tvheadend/archive/f1c460feb.tar.gz -O tvh-src.tar.gz
          mkdir tvh-src && tar --strip=1 -xzf tvh-src.tar.gz -C tvh-src
          cp ${{ github.workspace }}/.github/patches/tvheadend43-new.patch tvh-src/
          cp ${{ github.workspace }}/.github/patches/up-libdvbcsa.patch tvh-src/

      # 3️⃣ Aplicar parches
      - name: 🧩 Apply patches
        run: |
          cd tvh-src
          git init
          git config user.name "CI"
          git config user.email "ci@example.com"
          git add .
          git commit -m "initial commit"
          patch -p1 < tvheadend43-new.patch
          patch -p1 < up-libdvbcsa.patch

      # 4️⃣ Compilar solo tvheadend
      - name: 🛠️ Build Tvheadend
        run: |
          cd tvh-src
          ./configure --prefix=/usr --enable-avahi --enable-dvbcsa
          make -j"$(nproc)" tvheadend

      # 5️⃣ Sustituir binario en el addon oficial
      - name: 📂 Replace tvheadend binary in addon
        run: |
          cp tvh-src/tvheadend tvh-official/service.tvheadend43/bin/tvheadend
          chmod +x tvh-official/service.tvheadend43/bin/tvheadend

      # 6️⃣ Empaquetar addon parcheado
      - name: 📦 Zip patched addon
        run: |
          cd tvh-official
          zip -r ../tvheadend43-patched.zip service.tvheadend43

      # 7️⃣ Subir artefacto final
      - name: 📤 Upload patched addon
        uses: actions/upload-artifact@v4
        with:
          name: tvheadend43-patched
          path: tvheadend43-patched.zip

      - name: ⬆️ Upload build logs
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: build-logs



