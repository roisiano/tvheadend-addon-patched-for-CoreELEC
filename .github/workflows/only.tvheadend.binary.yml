name: TVH parcheado rÃ¡pido (CoreELEC cacheado)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ”¨ Instalar dependencias CoreELEC
        run: |
          sudo apt-get update && sudo apt-get install -y \
            gcc g++ make git wget unzip zip patchutils rsync pkg-config autoconf automake libtool \
            xfonts-utils rdfind libparse-yapp-perl gperf xsltproc libxml-parser-perl lzop

      - name: ðŸ’¾ Cache CoreELEC build y sources
        uses: actions/cache@v4
        with:
          path: |
            CoreELEC/build.*
            CoreELEC/sources
          key: coreelec22-${{ runner.os }}-${{ hashFiles('.github/patches/*.patch') }}
          restore-keys: |
            coreelec22-${{ runner.os }}-

      - name: ðŸ“‚ Clonar CoreELEC si no existe
        run: |
          if [ ! -d CoreELEC ]; then
            git clone https://github.com/CoreELEC/CoreELEC
            cd CoreELEC
            git checkout coreelec-22
          fi

      - name: ðŸ›  Preparar toolchain si no existe
        run: |
          cd CoreELEC
          if [ ! -d build.* ]; then
            ARCH=aarch64 PROJECT=Amlogic-ce DEVICE=Amlogic-no make image
          fi

      - name: ðŸ“Œ Aplicar parches
        run: |
          cd CoreELEC
          patch -p1 < ../.github/patches/up-libdvbcsa.patch
          mkdir -p packages/addons/service/tvheadend43/patches
          cp ../.github/patches/tvheadend43-new.patch \
             packages/addons/service/tvheadend43/patches/tvheadend43-100-LS.patch

      - name: ðŸ”„ Recompilar solo libdvbcsa y tvheadend43
        run: |
          cd CoreELEC
          ARCH=aarch64 PROJECT=Amlogic-ce DEVICE=Amlogic-no scripts/build libdvbcsa
          ARCH=aarch64 PROJECT=Amlogic-ce DEVICE=Amlogic-no scripts/build tvheadend43

      - name: ðŸ“¥ Descargar addon oficial
        run: |
          mkdir official
          wget -O official/addon.zip \
            https://raw.githubusercontent.com/roisiano/tvheadend-addon-patched-for-CoreELEC/refs/heads/main/.github/sources/service.tvheadend43-22.0.4.3.zip
          unzip official/addon.zip -d official/addon

      - name: ðŸ“¦ Sustituir binario
        run: |
          cp CoreELEC/build.*/tvheadend43-*/.install_pkg/usr/bin/tvheadend \
             official/addon/bin/tvheadend

      - name: ðŸ—œ Reempaquetar addon
        run: |
          cd official/addon
          zip -rFS9 ../../service.tvheadend43-22.0.4.3-icam.zip *

      - name: ðŸ“¤ Subir artefacto
        uses: actions/upload-artifact@v4
        with:
          name: tvheadend43-icam
          path: service.tvheadend43-22.0.4.3-icam.zip




